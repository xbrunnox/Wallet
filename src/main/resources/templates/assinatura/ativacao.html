<html xmlns:th="https://www.thymeleaf.org">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="/css/bootstrap.css">
	<title>Ativação</title>
	<link rel="stylesheet" href="/css/font-awesome.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
		integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
		crossorigin="anonymous"></script>
</head>

<body>
	<div class="container-fluid">
		<nav class="navbar navbar-light bg-light">
			<a class="navbar-brand" href="/"> <img th:src="${'https://download.versatil-ia.com.br/' + afiliado.logo}"
					height="30" class="d-inline-block align-top"
					alt="${'https://download.versatil-ia.com.br/tradingnow-favicon.png'}"> <span
					style="font-weight: 600">&nbsp;&nbsp;Ativação de Conta</span>
			</a>
		</nav>
		<br>
		<input type="hidden" id="idConta">
		<div id="divConsultar" class="card" style="display: 'block'">
			<div class="card-body">
				<div class="row">
					<div class="col-3 col-sm-2" align="right">
						<label>Conta:</label>
					</div>
					<div class="col-6 col-sm-4">
						<input class="form-control" id="campoConsultarConta">
						<div id="divErro" style="display: none">
						</div>
					</div>
					<div class="col-3 col-sm-2">
						<button class="btn btn-sm btn-primary" onclick="javascript:consultarConta()">Consultar</button>
					</div>
				</div>
			</div>
		</div>
		<div id="divConta" class="card" style="display: none;">
			<div class="card-body">

				<div class="row">
					<div class="col-3 col-sm-2" align="right">Conta:</div>
					<div class="col-9">
						<Strong> <span id="campoConta"></span></Strong>
					</div>
				</div>
				<div class="row">
					<div class="col-3 col-sm-2" align="right">Nome:</div>
					<div class="col-9 col-sm-10">
						<Strong> <span id="campoNome"></span></Strong>
					</div>
				</div>
				<div class="row">
					<div class="col-3 col-sm-2" align="right">Corretora:</div>
					<div class="col-9 col-sm-10">
						<Strong> <span id="campoCorretora"></span></Strong>
					</div>
				</div>
			</div>
		</div>
		<div id="divPagamentos" class="card" style="display: none; margin-top: 20px;">
			<div class="card-body">
				<div id="divTabelaPagamentos"></div>
			</div>
		</div>
		<div id="divAutomacoes" class="card" style="display: none; margin-top: 20px;">
			<div class="card-body">
				<div id="divSelecaoAutomacao"></div>
			</div>
		</div>
		<div id="divBotoes" class="card" style="display: none; margin-top: 20px;">
			<div class="card-body">
				<button class="btn btn-primary btn-sm" onclick="javascript:gravar();">Ativar</button>
			</div>
		</div>
		<!-- Vertically centered modal -->
		<div class="modal fade" id="mensagemModal">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-body">
						<div class="row">
							<div id="modalMensagemTexto" class="col-12">
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary"
							onclick="javascript:fecharMensagemModal()">Fechar</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Vertically centered modal -->
		<div class="modal fade" id="errorModal">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-body">
						<div class="row">
							<div id="textoErrorModal" class="col-12">
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/js/jquery.form.js"></script>
<script type="text/javascript" src="/js/jquery.mask.min.js"></script>
<script type="text/javascript" src="/js/jquery.price_format.1.7.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/versatil.js"></script>
<script type="text/javascript">
	function consultarConta() {
		var conta = $('#campoConsultarConta').val();
		$.ajax({
			url: '/conta/info/' + conta,
			success: function (retorno) {
				if (retorno.idAssinatura) {
					$('#divErro').css("display", "block");
					$('#divErro').html('<small style="color: red;">Esta conta já se encontra ativa.</small>');
				} else if (retorno.nome) {
					$('#campoConta').html(retorno.conta);
					$('#campoNome').html(retorno.nome);
					$('#campoCorretora').html(retorno.corretora);
					$('#divConsultar').css("display", "none");
					$('#divConta').css("display", "block");
					$('#divPagamentos').css("display", "block");
					$('#divAutomacoes').css("display", "block");
					$('#divBotoes').css("display", "block");
					$('#idConta').val(retorno.conta);
					consultarPagamentos();
					consultarAutomacoes();
				} else {
					$('#divErro').css("display", "block");
					$('#divErro').html('<small style="color: red;">Conta não existe.</small>');
				}
			}
		});
	}

	function consultarPagamentos() {
		$.ajax({
			url: '/pagamento/nao-associados/15',
			success: function (retorno) {
				var html = '<form><table class="table table-striped table-condensed">';

				html += '<tr>';
				html += '<td>';
				html += '<input type="radio" name="idPagamento" value="0">';
				html += '</td>';
				html += '<td><small>--/--/----';
				html += '<small></td>';
				html += '<td>Pagamento não informado</td:';
				html += '<td align="right">&nbsp;</td>';
				html += '</tr>';

				retorno.forEach(function (pagamento, i) {
					var dataPagamento = new Date(pagamento.dataAtualizacao);

					html += '<tr>';
					html += '<td>';
					html += '<input type="radio" name="idPagamento" value="' + pagamento.id + '">';
					html += '</td>';
					html += '<td><small>';
					html += dataPagamento.toLocaleDateString('pt-BR');
					html += '<br>';
					html += extractHourMinutesFromOffsetDate(pagamento.dataAtualizacao);
					html += '<small></td>';
					html += '<td><small>';
					html += pagamento.nome;
					html += '<br><i>';
					html += pagamento.produto;
					html += '</i></small></td>';
					html += '<td align="right"><small>';
					html += formatarDecimal(pagamento.valor, 2);
					html += '<br>';
					html += pagamento.refPedido;
					html += '</small></td>';
					html += '</tr>';

				});
				html += '</form></table>';
				$('#divTabelaPagamentos').html(html);
			}
		});
	}

	function consultarAutomacoes() {
		$.ajax({
			url: '/automacao/listar-ativas',
			success: function (retorno) {
				var html = '<table class="table table-striped table-condensed">';
				retorno.forEach(function (automacao, i) {
					html += '<tr>';
					html += '<td>';
					html += '<input type="radio" name="idAutomacao" value="' + automacao.id + '">';
					html += '</td>';
					html += '<td><small>';
					html += automacao.id;
					html += '</small></td>';
					html += '<td><small>';
					html += automacao.descricao;
					html += '</small></td>';
					html += '</tr>';
				});
				html += '</table>';
				$('#divSelecaoAutomacao').html(html);
			}
		});
	}

	function gravar() {
		var formAtivacao = {};
		formAtivacao.idConta = $('#idConta').val();
		formAtivacao.idExpert = $('input[name="idAutomacao"]:checked').val();
		formAtivacao.idPagamento = $('input[name="idPagamento"]:checked').val();
		jQuery.post({
			url: '/assinatura/ativar',
			data: JSON.stringify(formAtivacao),
			contentType: "application/json; charset=utf-8",
			dataType: "json",
			success: function (retorno) {
				$('#modalMensagemTexto').html("Conta ativada com sucesso");
				$('#mensagemModal').modal({
					show: true
				});
			},
			error: function (erro) {
				console.log(erro);
				$('#textoErrorModal').html(erro.responseJSON.message);
				$('#errorModal').modal('show');
			},
			async: false
		});
	}

	function fecharMensagemModal() {
		$('#mensagemModal').modal('hide');
		location.reload();
	}
</script>

</html>