<html xmlns:th="https://www.thymeleaf.org">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="/css/bootstrap.css">
	<title>Pagamentos (Tratamento Pendente) - Vers√°til IA</title>
	<link rel="stylesheet" href="/css/font-awesome.min.css">
</head>
<style>
	.fonte-tabela {
		font-weight: 600;
		font-size: 80%;
	}
</style>

<body>
	<nav class="navbar navbar-light bg-light">
		<a class="navbar-brand" href="/assinaturas"> <img src="/vst-ia.png" height="30" class="d-inline-block align-top"
				alt="">
			<span style="font-weight: 600; font-size: 16px;">&nbsp;&nbsp;Pagamentos
				(Tratamento Pendente)</span>
		</a>
	</nav>
	<br>
	<div class="container-fluid">
		<div class="row">
			<div class="col-12">
				<table class="table table-striped">
					<thead>
						<tr>
							<th>Data</th>
							<th>Nome</th>
							<th class="d-none d-sm-block" style="text-align: right;">Email/Telefone</th>
							<th style="text-align: right;">Valor</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="pagamento : ${pagamentosList}">
							<td><span class="fonte-tabela"
									th:text="${#temporals.format(pagamento.dataAtualizacao, 'dd/MM/yy')}"></span>
								<br> <small><span class="fonte-tabela"
										th:text="${#temporals.format(pagamento.dataAtualizacao, 'HH:mm:ss')}"></span></small>
							</td>
							<td><span class="fonte-tabela" th:text="${pagamento.nome}"></span>
								<br> <small><span class="fonte-tabela"
										th:text="${pagamento.plataforma +'-'+ pagamento.refPedido}"></span></small>
							</td>

							<td class="fonte-tabela d-none d-sm-block" align="right"><span
									th:text="${pagamento.email}"></span><br> <small><span
										th:text="${pagamento.telefone}"></span></small></td>
							<td class="fonte-tabela" align="right"><a
									th:href="'javascript:associarPagamento('+${pagamento.id}+');'">
									<span
										th:text="${#numbers.formatDecimal(pagamento.valor, 1, 'POINT', 2, 'COMMA')}"></span>
								</a>
						</tr>
						<tr>
							<td colspan="4"><span class="fonte-tabela" th:text="${pagamentosList.size()}"></span></td>
						</tr>
					</tbody>
				</table>

			</div>
		</div>
	</div>
	<!-- Modal -->
	<div class="modal fade" id="associarPagamentoModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
		aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">Associar
						Pagamento</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-3" align="right">
							<label>ID:</label>
						</div>
						<div class="col-4">
							<input class="form-control" id="idPagamento">
						</div>
					</div>
					<div class="row">
						<div class="col-3" align="right">
							<label>Nome:</label>
						</div>
						<div class="col-9">
							<input class="form-control" id="nomePagamento">
						</div>
					</div>
					<div class="row">
						<div class="col-3" align="right">
							<label>Valor:</label>
						</div>
						<div class="col-4">
							<input class="form-control" id="valorPagamento">
						</div>
					</div>
					<div class="row">
						<div class="col-3" align="right">
							<label>Assinatura:</label>
						</div>
						<div class="col-9">
							<select class="form-control" id="assinaturaSelect"></select>
						</div>
					</div>
					<div class="row">
						<div class="col-3" align="right">&nbsp;</div>
						<div class="col-5">
							<div class="custom-control custom-checkbox">
								<input class="custom-control-input" type="checkbox" id="apenasAssociarCheck"> <label
									class="custom-control-label" for="apenasAssociarCheck">Apenas
									associar</label>
							</div>

						</div>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="javascript:associar();">Associar</button>
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
				</div>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript" src="/js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="/js/jquery.form.js"></script>
<script type="text/javascript" src="/js/jquery.mask.min.js"></script>
<script type="text/javascript" src="/js/jquery.price_format.1.7.min.js"></script>
<script type="text/javascript" src="/js/bootstrap.min.js"></script>
<script>
	function associarPagamento(idPagamento) {
		console.log('ID Pagamento: ' + idPagamento);

		$.ajax({
			url: '/pagamento/get/' + idPagamento,
			success: function (pagamento) {
				console.log(pagamento);
				$('#idPagamento').val(pagamento.id);
				$('#valorPagamento').val(formatarDecimal(pagamento.valor, 2));
				$('#nomePagamento').val(pagamento.nome);

				$.ajax({
					url: '/assinatura/list/',
					success: function (assinaturas) {
						console.log(assinaturas);
						$.each(assinaturas, function (key, assinatura) {
							$("#assinaturaSelect").append(
								'<option value=' + assinatura.id + '>'
								+ assinatura.conta + ' - '
								+ assinatura.nome + ' - '
								+ assinatura.dataVencimento
								+ '</option>');
						})
					}
				});
			}
		});

		$('#associarPagamentoModal').modal({
			show: true
		});
	}

	function associar() {
		var requestAssociar = {};

		requestAssociar.idPagamento = $('#idPagamento').val();
		requestAssociar.idAssinatura = $('#assinaturaSelect').val();
		requestAssociar.apenasAssociar = $('#apenasAssociarCheck').is(
			":checked");

		console.log('Associando ' + requestAssociar.idPagamento + ' para '
			+ requestAssociar.idAssinatura);
		console.log(requestAssociar);
		$.ajax({
			url: "/pagamento/associar-tratar",
			type: "POST",
			data: JSON.stringify(requestAssociar),
			// dataType : "json",
			contentType: "application/json; charset=utf-8",
			success: function () {
				alert('Associado com sucesso');
				location.reload(true);
			}
		}).fail(function (response) {
			var error = JSON.parse(response.responseText);
			console.log(error);
			alert(error.message);
		});
	}

	function formatarNumero(numero) {
		if (!numero)
			return '-';
		return numero.toLocaleString('pt-BR'); // "9.876.543,21"
	}

	function formatarDecimal(numero) {
		if (!numero)
			return '-';
		return numero.toLocaleString('pt-BR', {
			minimumFractionDigits: 2,
			maximumFractionDigits: 2
		}); // "9.876.543,21"
	}

	function formatarDecimal(numero, casasDecimais) {
		if (!numero)
			return '-';
		return numero.toLocaleString('pt-BR', {
			minimumFractionDigits: casasDecimais,
			maximumFractionDigits: casasDecimais
		}); // "9.876.543,21"
	}
</script>

</html>